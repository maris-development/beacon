name: CI

on:
    push:
        branches:
            - main

jobs:
    test:
        name: Rust tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install system dependencies (Dockerfile parity)
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    capnproto \
                    cmake \
                    curl \
                    libclang-dev \
                    libhdf5-dev \
                    libnetcdf-dev \
                    libsqlite3-dev \
                    netcdf-bin \
                    software-properties-common \
                    sqlite3 \
                    wget

            - name: Install Rust (1.89)
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: "1.89"

            - name: Cargo cache
              uses: Swatinem/rust-cache@v2

            - name: Run tests
              env:
                  RUST_BACKTRACE: "1"
              run: cargo test --workspace --no-fail-fast
